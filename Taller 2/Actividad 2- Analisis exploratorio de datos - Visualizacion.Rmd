---
title: "Taller 2 - Visualización y Exploración de bases de datos"
author: " Henry Carvajal (201718787),Julian Delgado (201712798) , Mariana Villabona (201816559)"
date: "Visualización y Exploración de datos para ciencias sociales"
output: html_document
---

```{r Setup, include=FALSE}
# --- Limpiar entorno
rm(list = ls())
gc()
closeAllConnections()

# --- Cargar librerías necesarias
library("pacman")
require("pacman")
p_load( tidyverse, data.table, lubridate, readxl, ggthemes, plotly, janitor,ggplot2,openxlsx, writexl,stringi, patchwork, skimr)

# --- Definir rutas
user <- Sys.getenv("USERNAME")

if (user == "judel") {
  path <- file.path("C:/Users", "judel", "OneDrive", "Documentos", 
                    "ANDES", "Semestre 3", "Visualizacion de datos", "Actividad 2")
} else if (user == "mvill") {
  path <- file.path("C:/Users", "mvill", "OneDrive", "Transitorio", "OneDrive", 
                    "Documentos", "GitHub", "Visualizaci-n-UniAndes","Taller 2")
} else if (user == "hncar") {
  path <- file.path("C:/Users", "hncar", "Documents", "GitHub", "Visualizaci-n-UniAndes")
} else {
  path <- choose.dir(caption = "Selecciona la carpeta con los archivos")
}

setwd(path)


# --- Cargar datos 
data <- file.path(path, "data/2025 JNA VP.xlsx")

data_migracion_hogares  <- read_excel(data, sheet = "Hogares") %>% clean_names()
data_migracion_personas <- read_excel(data, sheet = "Personas") %>% clean_names()
```

# Limpieza básica
```{r Ajuste texto}
limpiar_texto <- function(df) {
  df[] <- lapply(df, function(x) {
    if (is.character(x) | is.factor(x)) {
      x <- tolower(as.character(x))                        # pasar a minúsculas
      x <- stri_trans_general(x, "Latin-ASCII")            # quitar tildes
      return(x)
    } else {
      return(x)  # dejar igual las variables que no son texto
    }
  })
  return(as.data.frame(df))
}

# --- Aplicar a tus bases
data_migracion_hogares  <- limpiar_texto(data_migracion_hogares)
data_migracion_personas <- limpiar_texto(data_migracion_personas)
```

```{r Union bases}
data_migracion <- data_migracion_hogares %>%
  left_join(data_migracion_personas, by = "id_hogar")
```

## Exploración y creación de variables latentes

```{r A. ELIGIBILIDAD }
##############################################
# EDAD Y SEXO 
##############################################

# Histograma Sexo
data_migracion$sexo_desagregado <- ifelse(data_migracion$demo2 == "Otro",
                                    "Otros",
                                    "Sexo biológico")

ggplot(data_migracion, aes(x = demo1)) +
  geom_histogram(bins = 20, fill = "steelblue", alpha = 0.7) +
  facet_wrap(~ sexo_desagregado + demo2, scales = "free_y") +
  labs(title = "Histograma de edad desagregado",
       x = "Edad", y = "Cuenta") +
  theme_minimal()

# Densidad por sexo y edad
ggplot(data_migracion, aes(x = demo1, fill = demo2)) +
  geom_density(alpha = 0.5) +
  labs(title = "Densidad de Edad por Sexo",
       x = "Edad",
       y = "Densidad") +
  theme_minimal()

# Probabilidades por edades
breaks <- pretty(range(data_migracion$demo1, na.rm = TRUE), n = 20)
dens_bins <- data_migracion %>%
  mutate(bin = cut(demo1, breaks = breaks, include.lowest = TRUE)) %>%
  group_by(demo2, bin) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(demo2) %>%
  mutate(freq = n / sum(n))  

# Rangos de edades 
data_migracion$rangos_edades <- cut(
  data_migracion$demo1,
  breaks = c(15, 25, 40, 70, Inf),
  labels = c("Joven", "Adulto Joven", "Adulto", "Adulto Mayor"),
  right = TRUE, include.lowest = TRUE
)
rm(dens_bins,breaks)

##############################################
# JEFES DE HOGAR 
##############################################
data_migracion %>%
  count(demo3) # Hay 8603 personas que reportan ser jefes de hogar

data_migracion %>%
  filter(!is.na(demo3) & demo3 != "") %>%
  count(demo5) # Todas las personas que no son jefes de hogar dicen poder
               # Responder por los miembros del hogar, coincide con                     # hogares sin jefes de hogar

# Identificar hogares sin jefes de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(no_tiene_jefe = as.integer(all(demo3 != "si" | is.na(demo3)))) %>%
  ungroup()

data_migracion %>%
  distinct(id_hogar, intro5, no_tiene_jefe) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = sum(no_tiene_jefe),
    hogares_total = n(),
    porcentaje_sin_jefe = round(100 * hogares_sin_jefe / hogares_total, 1)
  ) %>%
  arrange(desc(hogares_sin_jefe)) # Resumen por ciudad

# Contar quién se puede reasignar cómo jefe de hogar. 
resumen_por_ciudad <- data_migracion %>%
  filter(no_tiene_jefe == 1) %>%                      
  group_by(intro5, id_hogar) %>%
  summarise(
    Puede_responder_por_el_hogar = any(demo5 == "si", na.rm = TRUE),    
    Total_sí = sum(demo5 == "si", na.rm = TRUE),    
    Total_miembros_promedio_por_hogar = n(),                                  # número de personas en ese hogar
    .groups = "drop"
  ) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = n(),   
    hogares_con_al_menos_un_sí = sum(Puede_responder_por_el_hogar),  
    promedio_sí_por_hogar = round(mean(Total_sí), 2),
    miembros_promedio = round(mean(Total_miembros_promedio_por_hogar), 2),    # promedio de miembros por hogar
    .groups = "drop"
  ) %>%
  arrange(desc(hogares_sin_jefe)) # En todos los hogares sin jefe de hogar
                                  # los miembros reportan que pueden responder                                   # por el resto. Por lo que se asigna                                          # aleatoriamente a cualquier integrante 
                                  # cómo jefe de hogar. 
resumen_por_ciudad
rm(resumen_por_ciudad)

# Asignar un jefe de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    demo3 = ifelse(no_tiene_jefe == 1 & row_number() == 1, "si", demo3)
  ) %>%
  ungroup()

##############################################
# INTENCIÓN DE MOVERSE
##############################################
intencion_moverse <- data_migracion %>%
  pivot_longer(
    cols = c(demo21_ing_red,
             demo21_suf_disc,
             demo21_aum_prec,
             demo21_desal_viv,
             demo21_no_alim,
             demo21_no_acces_sal,
             demo21_of_lab,
             demo21_acc_edu,
             demo21_acc_edu_nna,
             demo21_otro_inten),
    names_to = "variable",
    values_to = "valor"
  ) %>%
  group_by(intro5, variable) %>%
  summarise(n_1 = sum(valor == 1, na.rm = TRUE), .groups = "drop") %>%
  arrange(intro5, variable)

rm(intencion_moverse)

# Moverse por Falta de ingresos
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    carencia_ingresos = as.integer(any(
      demo21_ing_red == 1 | demo21_aum_prec == 1 | demo21_of_lab == 1,
      na.rm = TRUE
    ))
  ) %>% ungroup()

# Moverse por carencias de servicios (incluye educación y alimentación)
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    carencia_servicios = as.integer(any(
      demo21_desal_viv == 1 | demo21_no_alim == 1 | 
        demo21_no_acces_sal == 1| demo21_acc_edu == 1|
        demo21_acc_edu_nna ==1),
      na.rm = TRUE
    )) %>% ungroup()

# Moverse por discriminación (incluye desalojo)
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    discriminacion = as.integer(any(
      demo21_suf_disc == 1 | demo21_desal_viv == 1),
      na.rm = TRUE
    )) %>% ungroup()

# Moverse por otras causas
```

```{r B. INTENSIONES Y MOVIMIENTOS }
#########################################
# MIGRAR EN PRÓXIMOS 6 MESES
#########################################

data_migracion <- data_migracion %>%
  mutate(
    `6M_sinmov`      = ifelse(demo22 == "no tienen la intencion de moverse", 1, 0),
    `6M_Mudar_barrio`= ifelse(demo22 == "si, nos vamos a mudar de barrio al interior de esta ciudad", 1, 0),
    `6M_Depto`       = ifelse(demo22 == "si, nos vamos a cambiar a otro departamento al interior de colombia", 1, 0),
    `6M_Venezuela`   = ifelse(demo22 == "si, irnos a venezuela", 1, 0),
    `6M_OtroPais`    = ifelse(demo22 == "si, irnos a otro pais (diferente a venezuela)", 1, 0),
    `6M_MismoDpto`   = ifelse(demo22 == "si, nos vamos a cambiar de municipio pero en el mismo departamento actual", 1, 0)
  )

resumen_intencion_6M <- data_migracion %>%
  group_by(intro5) %>%
  summarise(
    sinmov = sum(`6M_sinmov`, na.rm = TRUE),
    mudar_barrio = sum(`6M_Mudar_barrio`, na.rm = TRUE),
    depto = sum(`6M_Depto`, na.rm = TRUE),
    venezuela = sum(`6M_Venezuela`, na.rm = TRUE),
    otro_pais = sum(`6M_OtroPais`, na.rm = TRUE),
    mismo_dpto = sum(`6M_MismoDpto`, na.rm = TRUE),
    .groups = "drop"
  )
resumen_intencion_6M

#########################################
# HACE CUÁNTO TIEMPO RESIDE EN EL HOGAR
#########################################
data_migracion <- data_migracion %>%
  mutate(
    meses_en_lugar = case_when(
      demo12a %in% c("no sabe", "prefiere no responder") ~ NA_character_,
      demo12a == "menos de 1 mes" ~ "<1",
      demo12a == "entre 1 mes y menos de 6 meses" ~ "1-6",
      demo12a == "entre 6 meses y menos de 1 ano" ~ "6-12",
      demo12a == "entre 1 ano y menos de 2 anos" ~ "12-24",
      demo12a == "entre 2 y menos de 3 anos" ~ "24-36",
      demo12a == "entre 3 y 10 anos" ~ "36-120",
      demo12a == "mas de 10 anos" ~ ">120",
      TRUE ~ NA_character_
    ),
    meses_en_lugar = factor(
      meses_en_lugar,
      levels = c("<1", "1-6", "6-12", "12-24", "24-36", "36-120", ">120"),
      ordered = TRUE
    )
  )

resumen_meses_lugar <- data_migracion %>%
  group_by(intro5, meses_en_lugar) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(intro5) %>%
  mutate(
    pct = round(100 * n / sum(n), 1)   # porcentaje dentro de cada ciudad
  ) %>%
  arrange(intro5, meses_en_lugar)
resumen_meses_lugar

#########################################
# RAZÓN POR LA QUE MIGRÓ A RESIDENCIA ACTUAL 
#########################################
data_migracion <- data_migracion %>%
  mutate(
    Migro_por_violencia = ifelse(demo17 %in% c(
      "la persona o alguien cercano fue victima 
      de violencia (extorsion, agresiones, etc.) o amenazas",
      "temor por la situacion general de violencia / inseguridad"), 1, 0),
    
    Migro_por_familia = ifelse(demo17 %in% c(
      "acompanar a otros miembros del hogar",
      "reunificacion familiar"), 1, 0),
    
    Migro_por_discriminacion = ifelse(demo17 %in% c(
      "salud mental o fisica",
      "temor de ser perseguido/a, agredido/a o discriminado/a"), 1, 0),
    
    Migro_por_trabajo = ifelse(demo17 == "trabajo", 1, 0),
    
    Migro_por_educacion = ifelse(demo17 == "educacion", 1, 0),
    
    Migro_por_des_natural = ifelse(demo17 == "desastres naturales", 1, 0),
    
    Migro_por_alimentos = ifelse(demo17 == "alimentos", 1, 0)
  )


resumen_motivos <- data_migracion %>%
  group_by(intro5) %>%
  summarise(
    violencia      = sum(Migro_por_violencia, na.rm = TRUE),
    familia        = sum(Migro_por_familia, na.rm = TRUE),
    discriminacion = sum(Migro_por_discriminacion, na.rm = TRUE),
    trabajo        = sum(Migro_por_trabajo, na.rm = TRUE),
    educacion      = sum(Migro_por_educacion, na.rm = TRUE),
    des_natural    = sum(Migro_por_des_natural, na.rm = TRUE),
    alimentos      = sum(Migro_por_alimentos, na.rm = TRUE),
    .groups = "drop"
  )

```

```{r K. AGUA, SANEAMIENTO E HIGIENE (WASH)}
#########################################
# MIGRAR EN PRÓXIMOS 6 MESES
#########################################
data_migracion %>%
  count(wash1) 

```

```{r Conteo hogares}
# --- Contar cuántas veces aparece cada id_hogar
conteo_hogares <- data_bogota %>%
  count(id_hogar) %>%
  arrange(desc(n))
```

Se prioriza el registro del jefe de hogar en caso de no existir se escoje otro

```{r Filtro Jefe de hogar}
# --- Quedarse con un registro por hogar, prefiriendo demo3 == "si"
data_filtrada <- data_bogota %>%
  group_by(id_hogar) %>%
  arrange(desc(demo3 == "si")) %>%  # ordena poniendo primero los que tienen demo3 == "si"
  slice(1) %>%                      # toma el primer registro de cada hogar
  ungroup()
```

```{r Numero de registros con Jefe de Hogar}
table(data_filtrada$demo3)
```

```{r Respuesta con valores de 0 y 1 para multiples opciones}
# --- 1. Preguntas de opción múltiple (prefijos)
preg_multi <- c("demo23", "proteccion1006", "proteccion1007",
                "mediosvida8a", "mediosvida5", "mediosvida7",
                "mediosvida9b", "alojamiento3", "alojamiento4",
                "alojamiento5", "alojamiento10", "alojamiento12")

# --- 2. Detectar columnas (prefijo + "_")
cols_multi <- names(data_filtrada)[str_detect(
  names(data_filtrada),
  paste0("^(", paste(preg_multi, collapse="|"), ")_")
)]

# --- 3. Pasar a formato largo
data_encuesta_long <- data_filtrada %>%
  pivot_longer(
    cols         = all_of(cols_multi),
    names_to     = c("pregunta", "respuesta"),
    names_pattern = "([^_]+)_(.*)",   # divide en prefijo vs resto
    values_to    = "valor"
  ) %>%
  filter(valor == 1)

# --- 4. Resumen de frecuencias
resumen_multi <- data_encuesta_long %>%
  count(pregunta, respuesta, name = "conteo") %>%
  arrange(pregunta, desc(conteo))

```

```{r Cuantas preguntas de medios de vida selecciono cada hogar}
table(data_filtrada$demo3)
```

```{r Observacion de Variables relacionadas con el acceso al sistema financiero}
# --- 1. Hogares sin productos financieros
hogares_sin_finanzas <- data_filtrada %>%
  filter(mediosvida7_mediosvida7_ninguno == 1) %>%
  pull(id_hogar)

# --- 2. Filtrar dificultades de emprendimiento (mediosvida9b)
dificultades_emprend <- data_encuesta_long %>%
  filter(pregunta == "mediosvida9b",
         id_hogar %in% hogares_sin_finanzas,
         respuesta %in% c("credito", "docu_mentacion"))

# --- 3a. Resumen por menciones
resumen_dificultades_menciones <- dificultades_emprend %>%
  count(respuesta, name = "conteo")

# --- 3b. Resumen por hogares únicos
resumen_dificultades_hogar <- dificultades_emprend %>%
  group_by(respuesta) %>%
  summarise(n_hogares = n_distinct(id_hogar))

# --- 4a. Gráfico por menciones
plot_menciones <- ggplot(resumen_dificultades_menciones,
                         aes(x = respuesta, y = conteo, fill = respuesta)) +
  geom_col() +
  labs(title = "Dificultades para emprender (menciones)",
       x = "Tipo de dificultad",
       y = "Número de menciones") +
  theme_minimal()

# --- 4b. Gráfico por hogares únicos
plot_hogares <- ggplot(resumen_dificultades_hogar,
                       aes(x = respuesta, y = n_hogares, fill = respuesta)) +
  geom_col() +
  labs(title = "Dificultades para emprender (hogares únicos)",
       x = "Tipo de dificultad",
       y = "Número de hogares") +
  theme_minimal()

# --- 5. Mostrar ambos gráficos lado a lado
plot_menciones + plot_hogares

```

```{r Hogares que marcaron ambas dificultades}
# --- Hogares que marcaron ambas dificultades
hogares_ambas <- dificultades_emprend %>%
  filter(respuesta %in% c("credito", "docu_mentacion")) %>%
  group_by(id_hogar) %>%
  summarise(n_dificultades = n_distinct(respuesta)) %>%
  filter(n_dificultades == 2)

# --- Número de hogares en cada grupo
conteo_combinado <- tibble(
  categoria = c("Solo crédito", "Solo documentación", "Ambas"),
  n_hogares = c(
    length(setdiff(
      dificultades_emprend$id_hogar[dificultades_emprend$respuesta == "credito"],
      dificultades_emprend$id_hogar[dificultades_emprend$respuesta == "docu_mentacion"]
    )),
    length(setdiff(
      dificultades_emprend$id_hogar[dificultades_emprend$respuesta == "docu_mentacion"],
      dificultades_emprend$id_hogar[dificultades_emprend$respuesta == "credito"]
    )),
    nrow(hogares_ambas)
  )
)

print(conteo_combinado)

# --- Gráfico comparativo
ggplot(conteo_combinado, aes(x = categoria, y = n_hogares, fill = categoria)) +
  geom_col() +
  labs(title = "Combinación de dificultades para emprender (hogares sin productos financieros)",
       x = "Categoría",
       y = "Número de hogares") +
  theme_minimal()
```
# Exploración sección B

```{r Hogares que marcaron ambas dificultades}
unique(data_migracion["demo8"])
```

