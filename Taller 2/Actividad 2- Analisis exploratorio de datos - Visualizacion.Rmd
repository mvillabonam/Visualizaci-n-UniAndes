---
title: "Taller 2 - Visualización y Exploración de bases de datos"
author: " Henry Carvajal (201718787),Julian Delgado (201712798) , Mariana Villabona (201816559)"
date: "Visualización y Exploración de datos para ciencias sociales"
output: html_document
---

```{r Setup, include=FALSE}
# --- Limpiar entorno
rm(list = ls())
gc()
closeAllConnections()

# --- Cargar librerías necesarias
library("pacman")
require("pacman")
p_load( tidyverse, data.table, lubridate, readxl, ggthemes, plotly, janitor,ggplot2,openxlsx, writexl,stringi, patchwork, skimr,tidyverse, readxl, ggthemes, plotly,sf,osmdata,dplyr)

# --- Definir rutas
user <- Sys.getenv("USERNAME")

if (user == "judel") {
  path <- file.path("C:/Users", "judel", "OneDrive", "Documentos", 
                    "ANDES", "Semestre 3", "Visualizacion de datos", "Actividad 2")
} else if (user == "mvill") {
  path <- file.path("C:/Users", "mvill", "OneDrive", "Transitorio", "OneDrive", 
                    "Documentos", "GitHub", "Visualizaci-n-UniAndes","Taller 2")
} else if (user == "hncar") {
  path <- file.path("C:/Users", "hncar", "Documents", "GitHub", "Visualizaci-n-UniAndes")
} else {
  path <- choose.dir(caption = "Selecciona la carpeta con los archivos")
}

setwd(path)


# --- Cargar datos 
data <- file.path(path, "data/2025 JNA VP.xlsx")
# Adicional para Visualización
col_mpios <- st_read("data/shapes.shp", quiet = TRUE)

data_migracion_hogares  <- read_excel(data, sheet = "Hogares") %>% clean_names()
data_migracion_personas <- read_excel(data, sheet = "Personas") %>% clean_names()
```

# Limpieza básica
```{r Ajuste texto}
limpiar_texto <- function(df) {
  df[] <- lapply(df, function(x) {
    if (is.character(x) | is.factor(x)) {
      x <- tolower(as.character(x))                        # pasar a minúsculas
      x <- stri_trans_general(x, "Latin-ASCII")            # quitar tildes
      return(x)
    } else {
      return(x)  # dejar igual las variables que no son texto
    }
  })
  return(as.data.frame(df))
}

# --- Aplicar a tus bases
data_migracion_hogares  <- limpiar_texto(data_migracion_hogares)
data_migracion_personas <- limpiar_texto(data_migracion_personas)
col_mpios <- limpiar_texto(col_mpios)
```

```{r Union bases}
data_migracion <- data_migracion_hogares %>%
  left_join(data_migracion_personas, by = "id_hogar")
```

## Exploración y creación de variables latentes
```{r A. ELIGIBILIDAD }
##############################################
# EDAD Y SEXO 
##############################################

# Histograma Sexo
data_migracion$sexo_desagregado <- ifelse(data_migracion$demo2 == "Otro",
                                    "Otros",
                                    "Sexo biológico")

ggplot(data_migracion, aes(x = demo1)) +
  geom_histogram(bins = 20, fill = "steelblue", alpha = 0.7) +
  facet_wrap(~ sexo_desagregado + demo2, scales = "free_y") +
  labs(title = "Histograma de edad desagregado",
       x = "Edad", y = "Cuenta") +
  theme_minimal()

# Densidad por sexo y edad
ggplot(data_migracion, aes(x = demo1, fill = demo2)) +
  geom_density(alpha = 0.5) +
  labs(title = "Densidad de Edad por Sexo",
       x = "Edad",
       y = "Densidad") +
  theme_minimal()

# Probabilidades por edades
breaks <- pretty(range(data_migracion$demo1, na.rm = TRUE), n = 20)
dens_bins <- data_migracion %>%
  mutate(bin = cut(demo1, breaks = breaks, include.lowest = TRUE)) %>%
  group_by(demo2, bin) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(demo2) %>%
  mutate(freq = n / sum(n))  

# Rangos de edades 
data_migracion$rangos_edades <- cut(
  data_migracion$demo1,
  breaks = c(15, 25, 40, 70, Inf),
  labels = c("Joven", "Adulto Joven", "Adulto", "Adulto Mayor"),
  right = TRUE, include.lowest = TRUE
)
rm(dens_bins,breaks)

##############################################
# JEFES DE HOGAR 
##############################################
data_migracion %>%
  count(demo3) # Hay 8603 personas que reportan ser jefes de hogar

data_migracion %>%
  filter(!is.na(demo3) & demo3 != "") %>%
  count(demo5) # Todas las personas que no son jefes de hogar dicen poder
               # Responder por los miembros del hogar, coincide con                     # hogares sin jefes de hogar

# Identificar hogares sin jefes de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(no_tiene_jefe = as.integer(all(demo3 != "si" | is.na(demo3)))) %>%
  ungroup()

data_migracion %>%
  distinct(id_hogar, intro5, no_tiene_jefe) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = sum(no_tiene_jefe),
    hogares_total = n(),
    porcentaje_sin_jefe = round(100 * hogares_sin_jefe / hogares_total, 1)
  ) %>%
  arrange(desc(hogares_sin_jefe)) # Resumen por ciudad

# Contar quién se puede reasignar cómo jefe de hogar. 
resumen_por_ciudad <- data_migracion %>%
  filter(no_tiene_jefe == 1) %>%                      
  group_by(intro5, id_hogar) %>%
  summarise(
    Puede_responder_por_el_hogar = any(demo5 == "si", na.rm = TRUE),    
    Total_sí = sum(demo5 == "si", na.rm = TRUE),    
    Total_miembros_promedio_por_hogar = n(),                                  # número de personas en ese hogar
    .groups = "drop"
  ) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = n(),   
    hogares_con_al_menos_un_sí = sum(Puede_responder_por_el_hogar),  
    promedio_sí_por_hogar = round(mean(Total_sí), 2),
    miembros_promedio = round(mean(Total_miembros_promedio_por_hogar), 2),    # promedio de miembros por hogar
    .groups = "drop"
  ) %>%
  arrange(desc(hogares_sin_jefe)) # En todos los hogares sin jefe de hogar
                                  # los miembros reportan que pueden responder                                   # por el resto. Por lo que se asigna                                          # aleatoriamente a cualquier integrante 
                                  # cómo jefe de hogar. 
resumen_por_ciudad
rm(resumen_por_ciudad)

# Asignar un jefe de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    demo3 = ifelse(no_tiene_jefe == 1 & row_number() == 1, "si", demo3)
  ) %>%
  ungroup()

##############################################
# INTENCIÓN DE MOVERSE
##############################################
intencion_moverse <- data_migracion %>%
  pivot_longer(
    cols = c(demo21_ing_red,
             demo21_suf_disc,
             demo21_aum_prec,
             demo21_desal_viv,
             demo21_no_alim,
             demo21_no_acces_sal,
             demo21_of_lab,
             demo21_acc_edu,
             demo21_acc_edu_nna,
             demo21_otro_inten),
    names_to = "variable",
    values_to = "valor"
  ) %>%
  group_by(intro5, variable) %>%
  summarise(n_1 = sum(valor == 1, na.rm = TRUE), .groups = "drop") %>%
  arrange(intro5, variable)

rm(intencion_moverse)

# Moverse por Falta de ingresos
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    carencia_ingresos = as.integer(any(
      demo21_ing_red == 1 | demo21_aum_prec == 1 | demo21_of_lab == 1,
      na.rm = TRUE
    ))
  ) %>% ungroup()

# Moverse por carencias de servicios (incluye educación y alimentación)
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    carencia_servicios = as.integer(any(
      demo21_desal_viv == 1 | demo21_no_alim == 1 | 
        demo21_no_acces_sal == 1| demo21_acc_edu == 1|
        demo21_acc_edu_nna ==1),
      na.rm = TRUE
    )) %>% ungroup()

# Moverse por discriminación (incluye desalojo)
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    discriminacion = as.integer(any(
      demo21_suf_disc == 1 | demo21_desal_viv == 1),
      na.rm = TRUE
    )) %>% ungroup()

# Moverse por otras causas

##############################################
# AÑOS
##############################################
data_migracion <- data_migracion %>%
  mutate(
    fecha_demo8 = ymd(demo8),   # convertir string a fecha
    meses_transcurridos = interval(fecha_demo8, today()) %/% months(1),
    anios_en_Col = meses_transcurridos / 12
  )

```

```{r B. INTENSIONES Y MOVIMIENTOS }
#########################################
# MIGRAR EN PRÓXIMOS 6 MESES
#########################################

data_migracion <- data_migracion %>%
  mutate(
    `6M_sinmov`      = ifelse(demo22 == "no tienen la intencion de moverse", 1, 0),
    `6M_Mudar_barrio`= ifelse(demo22 == "si, nos vamos a mudar de barrio al interior de esta ciudad", 1, 0),
    `6M_Depto`       = ifelse(demo22 == "si, nos vamos a cambiar a otro departamento al interior de colombia", 1, 0),
    `6M_Venezuela`   = ifelse(demo22 == "si, irnos a venezuela", 1, 0),
    `6M_OtroPais`    = ifelse(demo22 == "si, irnos a otro pais (diferente a venezuela)", 1, 0),
    `6M_MismoDpto`   = ifelse(demo22 == "si, nos vamos a cambiar de municipio pero en el mismo departamento actual", 1, 0)
  )

#########################################
# HACE CUÁNTO TIEMPO RESIDE EN EL HOGAR
#########################################
data_migracion <- data_migracion %>%
  mutate(
    meses_en_lugar = case_when(
      demo12a %in% c("no sabe", "prefiere no responder") ~ NA_character_,
      demo12a == "menos de 1 mes" ~ "<1",
      demo12a == "entre 1 mes y menos de 6 meses" ~ "1-6",
      demo12a == "entre 6 meses y menos de 1 ano" ~ "6-12",
      demo12a == "entre 1 ano y menos de 2 anos" ~ "12-24",
      demo12a == "entre 2 y menos de 3 anos" ~ "24-36",
      demo12a == "entre 3 y 10 anos" ~ "36-120",
      demo12a == "mas de 10 anos" ~ ">120",
      TRUE ~ NA_character_
    ),
    meses_en_lugar = factor(
      meses_en_lugar,
      levels = c("<1", "1-6", "6-12", "12-24", "24-36", "36-120", ">120"),
      ordered = TRUE
    )
  )

#########################################
# RAZÓN POR LA QUE MIGRÓ A RESIDENCIA ACTUAL 
#########################################
data_migracion <- data_migracion %>%
  mutate(
    Migro_por_violencia = ifelse(demo17 %in% c(
      "la persona o alguien cercano fue victima 
      de violencia (extorsion, agresiones, etc.) o amenazas",
      "temor por la situacion general de violencia / inseguridad"), 1, 0),
    
    Migro_por_familia = ifelse(demo17 %in% c(
      "acompanar a otros miembros del hogar",
      "reunificacion familiar"), 1, 0),
    
    Migro_por_discriminacion = ifelse(demo17 %in% c(
      "salud mental o fisica",
      "temor de ser perseguido/a, agredido/a o discriminado/a"), 1, 0),
    
    Migro_por_trabajo = ifelse(demo17 == "trabajo", 1, 0),
    
    Migro_por_educacion = ifelse(demo17 == "educacion", 1, 0),
    
    Migro_por_des_natural = ifelse(demo17 == "desastres naturales", 1, 0),
    
    Migro_por_alimentos = ifelse(demo17 == "alimentos", 1, 0)
  )

```

```{r K. AGUA, SANEAMIENTO E HIGIENE (WASH)}
#########################################
# ACCESO A AGUA
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    Acueducto_casa = as.integer(any(wash1 == "agua de tuberia por grifo", na.rm = TRUE)),
    AguaPublica_fueradecasa = as.integer(any(
      wash1 %in% c("perforaciones / pozos tubulares (publicos)",
                   "pilas o fuentes publicas (fuentes publicas)"),
      na.rm = TRUE
    )),
    Agua_FuentesNaturales = as.integer(any(
      wash1 %in% c("agua de lluvia",
                   "agua superficial (rio, quebrada, manantial, lago)"),
      na.rm = TRUE
    )),
    Agua_FuentesPrivadas = as.integer(any(
      wash1 %in% c("agua envasada, agua embotellada y agua en bolsitas",
                   "de pozo sin bomba, aljibe, jaguey o barreno; (no protegido)",
                   "suministro de agua, incluidos camiones cisterna y carros / tanques / tambores pequenos"),
      na.rm = TRUE
    )),
    Agua_NoAcceso = as.integer(any(wash1 == "no tiene acceso", na.rm = TRUE))
  ) %>%
  ungroup()

#########################################
# AGUA EN VIVIENDA
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    Acceso_agua_casa = as.integer(any(wash01 == "si", na.rm = TRUE)),
    No_Acceso_agua_casa = as.integer(any(wash01 == "no", na.rm = TRUE)),
    Acceso_agua_casa_Otro = as.integer(any(wash01 %in% c("no sabe", "prefiere no responder"), na.rm = TRUE))
  ) %>%
  ungroup()

#########################################
# TIEMPO PARA AGUA 
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    Agua_caminar_largo = as.integer(any(wash3 == "mas de 30 minutos", na.rm = TRUE)),
    Agua_caminar_corto = as.integer(any(wash3 == "menos de 30 minutos", na.rm = TRUE))
  ) %>%
  ungroup()

#########################################
# SATISFACCIÓN NECESIDADES BÁSICAS AGUA
#########################################
data_migracion <- data_migracion %>%
  mutate(
    Agua_Satisfaccion = case_when(
      wash5 == "si" ~ 1L,
      wash5 == "no" ~ 0L,
      TRUE ~ NA_integer_
    )
  )

#########################################
# TIEMPO DE COBERTURA DEL SERVICIO 
#########################################
data_migracion <- data_migracion %>%
  mutate(
    Agua_CoberturaTotal = ifelse(
      wash6 == "las 24 horas del dia, los 7 dias de la semana", 1L, 0L
    ),
    Agua_CoberturaMedia = ifelse(
      wash6 %in% c("llega a diario pero solo a ciertas horas del 
                   dia/en horarios restringidos",
                   "las 24 horas de 4 a 6 dias a la semana"), 1L, 0L
    ),
    Agua_MalaCobertura = ifelse(
      wash6 %in% c("las 24 horas 1 a 2 dias a la semana",
                   "las 24 horas 3 dias a la semana"), 1L, 0L
    )
  )

#########################################
# INFORMACIÓN SANEAMIENTO 
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    # Calidad
    Saneamiento_deCalidad = as.integer(any(
      wash11 %in% c("inodoro conectado a alcantarillado",
                    "inodoro conectado a pozo septico"),
      na.rm = TRUE
    )),
    
    # No calidad
    Saneamiento_noCalidad = as.integer(any(
      wash11 %in% c("letrinas colgantes o inodoro con descarga directa a fuentes de agua (bajamar)",
                    "inodoro sin conexion (banos portatiles)",
                    "defecacion al aire libre",
                    "letrina de pozo con losa y plataforma",
                    "no tiene servicio sanitario, pero tiene un lugar gratuito y seguro",
                    "no tiene servicio sanitario y tiene que pagar el servicio",
                    "letrina improvisada"),
      na.rm = TRUE
    )),
    
    # Letrinas
    Saneamiento_Letrina = as.integer(any(
      wash11 %in% c("letrinas colgantes o inodoro con descarga directa a fuentes de agua (bajamar)",
                    "inodoro sin conexion (banos portatiles)",
                    "letrina de pozo con losa y plataforma",
                    "letrina improvisada"),
      na.rm = TRUE
    )),
    
    # Privado
    Saneamiento_Privado = as.integer(any(
      wash11 == "no tiene servicio sanitario y tiene que pagar el servicio",
      na.rm = TRUE
    )),
    
    # Uso público
    Saneamiento_UsoPublico = as.integer(any(
      wash11 %in% c("no tiene servicio sanitario, pero tiene un lugar gratuito y seguro",
                    "inodoro sin conexion (banos portatiles)"),
      na.rm = TRUE
    )),
    
    # Sin cobertura
    Saneamiento_SinCobertura = as.integer(any(
      wash11 %in% c("defecacion al aire libre",
                    "no tiene servicio sanitario, pero tiene un lugar gratuito y seguro",
                    "no tiene servicio sanitario y tiene que pagar el servicio"),
      na.rm = TRUE
    ))
  ) %>%
  ungroup()


#########################################
# SERVICIO DE BASURA
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    Servicio_basuraPublico = as.integer(any(
      wash17 == "camion de basura municipal/punto de acopio formal", 
      na.rm = TRUE
    )),
    
    Servicio_basuraPrivado = as.integer(any(
      wash17 == "servicio informal (punto de acopio no autorizado, recicladores/cartoneros)", 
      na.rm = TRUE
    )),
    
    Servicio_Nobasura = as.integer(any(
      wash17 %in% c("no sabe",
                    "la tiran en la calle, via publica y/o rio",
                    "la queman o entierran"),
      na.rm = TRUE
    ))) %>%
  ungroup()

#########################################
# AMBIENTE CONTAMINADO
#########################################
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    AmbienteContaminado = as.integer(any(
      wash17 %in% c("la tiran en la calle, via publica y/o rio",
                    "la queman o entierran") |
      wash11 %in% c("defecacion al aire libre",
                    "letrinas colgantes o inodoro con descarga directa a fuentes de agua (bajamar)"),
      na.rm = TRUE
    ))
  ) %>%
  ungroup()

#########################################
# PRBLEMAS PARA ACCEDER A ARTÍCULOS DE HIGIENE 
#########################################
data_migracion <- data_migracion %>%
  mutate(
    wash20 = factor(
      wash20,
      levels = c("no (falta de jabon, lavamanos con agua)",
                 "si",
                 "utilizo gel antibacterial / toallas humedas / alcohol"),
      labels = c("No (falta de jabón/agua)", "Sí", "Gel/Toallas/Alcohol"),
      ordered = TRUE
    )
  )
```

Se prioriza el registro del jefe de hogar en caso de no existir se escoje otro
## Exploración y creación de variables latentes

```{r Estadísticas descriptivas}
# Tiempo de residencia en lugar en que se encuentra actualmente
resumen_meses_lugar <- data_migracion %>%
  group_by(intro5, meses_en_lugar) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(intro5) %>%
  mutate(
    pct = round(100 * n / sum(n), 1)   # porcentaje dentro de cada ciudad
  ) %>%
  arrange(intro5, meses_en_lugar)
resumen_meses_lugar

# Motivo por el que migró a residencia actual 
resumen_motivos <- data_migracion %>%
  group_by(intro5) %>%
  summarise(
    violencia      = sum(Migro_por_violencia, na.rm = TRUE),
    familia        = sum(Migro_por_familia, na.rm = TRUE),
    discriminacion = sum(Migro_por_discriminacion, na.rm = TRUE),
    trabajo        = sum(Migro_por_trabajo, na.rm = TRUE),
    educacion      = sum(Migro_por_educacion, na.rm = TRUE),
    des_natural    = sum(Migro_por_des_natural, na.rm = TRUE),
    alimentos      = sum(Migro_por_alimentos, na.rm = TRUE),
    .groups = "drop"
  )

# Intención de migrar en 6 meses
resumen_intencion_6M <- data_migracion %>%
  group_by(intro5) %>%
  summarise(
    sinmov = sum(`6M_sinmov`, na.rm = TRUE),
    mudar_barrio = sum(`6M_Mudar_barrio`, na.rm = TRUE),
    depto = sum(`6M_Depto`, na.rm = TRUE),
    venezuela = sum(`6M_Venezuela`, na.rm = TRUE),
    otro_pais = sum(`6M_OtroPais`, na.rm = TRUE),
    mismo_dpto = sum(`6M_MismoDpto`, na.rm = TRUE),
    .groups = "drop"
  )
resumen_intencion_6M


# ACCESO A AGUA
resumen_agua <- data_migracion %>%
  distinct(id_hogar, intro5, Acueducto_casa, AguaPublica_fueradecasa,
           Agua_FuentesNaturales, Agua_FuentesPrivadas, Agua_NoAcceso) %>%
  group_by(intro5) %>%
  summarise(
    hogares_con_Acueducto = sum(Acueducto_casa, na.rm = TRUE),
    hogares_con_AguaPublica_fuera = sum(AguaPublica_fueradecasa, na.rm = TRUE),
    hogares_con_AguaNatural = sum(Agua_FuentesNaturales, na.rm = TRUE),
    hogares_con_AguaPrivada = sum(Agua_FuentesPrivadas, na.rm = TRUE),
    hogares_sin_Agua = sum(Agua_NoAcceso, na.rm = TRUE),
    total_hogares = n(),
    .groups = "drop"
  ) %>%
  mutate(
    pct_Acueducto = round(100 * hogares_con_Acueducto / total_hogares, 1),
    pct_AguaPublica_fuera = round(100 * hogares_con_AguaPublica_fuera / total_hogares, 1),
    pct_AguaNatural = round(100 * hogares_con_AguaNatural / total_hogares, 1),
    pct_AguaPrivada = round(100 * hogares_con_AguaPrivada / total_hogares, 1),
    pct_NoAcceso = round(100 * hogares_sin_Agua / total_hogares, 1)
  )

# CAMINAR PARA ACCEDER A AGUA (CORTO < 30 MIN, LARGO > 30 MIN)
resumen_caminar <- data_migracion %>%
  distinct(id_hogar, intro5, Agua_caminar_largo, Agua_caminar_corto) %>%
  group_by(intro5) %>%
  summarise(
    hogares_largo = sum(Agua_caminar_largo, na.rm = TRUE),
    hogares_corto = sum(Agua_caminar_corto, na.rm = TRUE),
    total_hogares = n(),
    .groups = "drop"
  ) %>%
  mutate(
    pct_largo = round(100 * hogares_largo / total_hogares, 1),
    pct_corto = round(100 * hogares_corto / total_hogares, 1)
  ) %>%
  arrange(desc(total_hogares))
resumen_caminar


# ACCESO A SANEAMIENTO
resumen_saneamiento <- data_migracion %>%
  distinct(id_hogar, intro5, 
           Saneamiento_deCalidad, Saneamiento_noCalidad, 
           Saneamiento_Letrina, Saneamiento_Privado, 
           Saneamiento_UsoPublico, Saneamiento_SinCobertura) %>%
  group_by(intro5) %>%
  summarise(
    hogares_deCalidad     = sum(Saneamiento_deCalidad, na.rm = TRUE),
    hogares_noCalidad     = sum(Saneamiento_noCalidad, na.rm = TRUE),
    hogares_Letrina       = sum(Saneamiento_Letrina, na.rm = TRUE),
    hogares_Privado       = sum(Saneamiento_Privado, na.rm = TRUE),
    hogares_UsoPublico    = sum(Saneamiento_UsoPublico, na.rm = TRUE),
    hogares_SinCobertura  = sum(Saneamiento_SinCobertura, na.rm = TRUE),
    total_hogares         = n(),
    .groups = "drop"
  ) %>%
  mutate(
    pct_deCalidad    = round(100 * hogares_deCalidad / total_hogares, 1),
    pct_noCalidad    = round(100 * hogares_noCalidad / total_hogares, 1),
    pct_Letrina      = round(100 * hogares_Letrina / total_hogares, 1),
    pct_Privado      = round(100 * hogares_Privado / total_hogares, 1),
    pct_UsoPublico   = round(100 * hogares_UsoPublico / total_hogares, 1),
    pct_SinCobertura = round(100 * hogares_SinCobertura / total_hogares, 1)
  ) %>%
  arrange(desc(total_hogares))
resumen_saneamiento
```

## Cortar base a nivel de observación de interés

```{r Filtro ciudad y creacion variable hacinamiento}
# --- Filtrar Bogotá
data_bogota <- data_migracion %>%
  filter(intro5 == "bogota. d.c.")

# --- Quedarse con un registro por hogar, prefiriendo demo3 == "si"
data_filtrada <- data_bogota %>%
  group_by(id_hogar) %>%
  arrange(desc(demo3 == "si")) %>%  # ordena poniendo primero los que tienen demo3 == "si"
  slice(1) %>%                      # toma el primer registro de cada hogar
  ungroup()

# --- Calcular índice de hacinamiento
data_filtrada <- data_filtrada %>%
  mutate(
    personas_cuarto = miembros1 / alojamiento7,
    hacinamiento = case_when(
      is.na(personas_cuarto) ~ NA_character_,
      personas_cuarto <= 2 ~ "Sin hacinamiento",
      personas_cuarto > 2 & personas_cuarto <= 3 ~ "Moderado",
      personas_cuarto > 3 ~ "Crítico"
    )
  )
```

```{r Filtro Jefe de hogar}
# Variables únicas (riesgo desalojo, intención moverse, tiempo residencia)
vars_unica <- c("miembros1", "alojamiento7", "demo22", "demo12a")
```

```{r NA}
# --- NA en variables únicas
na_resumen <- sapply(data_filtrada[vars_unica], function(x) sum(is.na(x)))
na_resumen
```
```{r distribucion hacinamiento}
table(data_filtrada$hacinamiento, useNA = "ifany")
```
```{r distribucion hacinamiento}
# Orden lógico de categorías
data_filtrada$hacinamiento <- factor(
  data_filtrada$hacinamiento,
  levels = c("Sin hacinamiento", "Moderado", "Crítico")
)

# Gráfico de barras
ggplot(data_filtrada, aes(x = hacinamiento, fill = hacinamiento)) +
  geom_bar() +
  theme_minimal() +
  labs(
    title = "Distribución del hacinamiento en Bogotá",
    x = "Categoría de hacinamiento",
    y = "Número de hogares"
  ) +
  theme(legend.position = "none")
```
```{r distribucion hacinamiento}
hacinamiento_resumen <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(Frecuencia = n()) %>%
  mutate(Proporcion = round(100 * Frecuencia / sum(Frecuencia), 1))

hacinamiento_resumen
```

```{r comparacion variables de interes}
table(data_filtrada$hacinamiento, data_filtrada$demo22, useNA = "ifany")
```

```{r comparacion variables de medios de vida}
vars_financieras <- c(
  # Fuentes de ingreso
  "mediosvida5_mediosvida5_prestamos",
  "mediosvida5_mediosvida5_ahorros",
  "mediosvida5_mediosvida5_trabajo",
  "mediosvida5_mediosvida5_asistencia",
  "mediosvida5_mediosvida5_apoyocomunidad",
  "mediosvida5_mediosvida5_venderbienes",
  "mediosvida5_mediosvida5_donaciones",
  "mediosvida5_mediosvida5_notiene",  
  "mediosvida5_mediosvida5_otra",   
  "mediosvida5_mediosvida5_nosabe",  
  "mediosvida5_mediosvida5_prefiereno",    
  
  # Productos financieros
  "mediosvida7_mediosvida7_cuenta_ahorro",
  "mediosvida7_mediosvida7_cuenta_corriente",
  "mediosvida7_mediosvida7_cdt",
  "mediosvida7_mediosvida7_billetera_electronica",
  "mediosvida7_mediosvida7_deposito_bajo_monto",
  "mediosvida7_mediosvida7_microcredito",
  "mediosvida7_mediosvida7_prestamo_vivienda",
  "mediosvida7_mediosvida7_prestamo_vehiculo",
  "mediosvida7_mediosvida7_prestamo_de_libre_inversion",
  "mediosvida7_mediosvida7_tarjeta_de_credito",
  "mediosvida7_mediosvida7_otro",  
  "mediosvida7_mediosvida7_ninguno", 
  "mediosvida7_mediosvida7_no_sabe", 
  "mediosvida7_mediosvida7_noresponde"

)
```

```{r comparacion variables de medios de vida}
resumen_financieros <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(across(all_of(vars_financieras), ~ sum(. == "1", na.rm = TRUE))) 

resumen_financieros
```

```{r comparacion variables de medios de vida}
resumen_finanzas_largo <- resumen_financieros %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  )



resumen_finanzas_largo <- resumen_finanzas_largo %>%
  mutate(producto = str_replace_all(producto,
                                    c("mediosvida5_" = "",
                                      "mediosvida7_" = "")))

head(resumen_finanzas_largo, 10)
```

```{r comparacion variables de medios de vida}
# --- Para MEDIOS DE VIDA 5 (fuentes de ingresos/dinero)
resumen_mv5 <- resumen_financieros %>%
  select(hacinamiento, starts_with("mediosvida5")) %>% 
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  group_by(hacinamiento) %>%
  mutate(
    total = sum(conteo, na.rm = TRUE),
    porcentaje = round((conteo / total) * 100, 1),
    producto = gsub("mediosvida5_mediosvida5_", "", producto)  # limpiar nombres
  )

# --- Para MEDIOS DE VIDA 7 (productos financieros)
resumen_mv7 <- resumen_financieros %>%
  select(hacinamiento, starts_with("mediosvida7")) %>% 
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  group_by(hacinamiento) %>%
  mutate(
    total = sum(conteo, na.rm = TRUE),
    porcentaje = round((conteo / total) * 100, 1),
    producto = gsub("mediosvida7_mediosvida7_", "", producto)  # limpiar nombres
  )
```

```{r comparacion variables de medios de vida}
# --- Gráfico 1: Fuentes de ingresos (MV5)
ggplot(resumen_mv5, aes(x = hacinamiento, y = porcentaje, fill = producto)) +
  geom_col(position = "stack") +
  labs(
    title = "¿Actualmente en su hogar cuáles son las principales fuentes de ingresos/dinero?",
    x = "Nivel de hacinamiento",
    y = "Porcentaje"
  ) +
  theme_minimal()
```
```{r comparacion variables de medios de vida}
# --- Gráfico 2: Productos financieros (MV7)
ggplot(resumen_mv7, aes(x = hacinamiento, y = porcentaje, fill = producto)) +
  geom_col(position = "stack") +
  labs(
    title = "¿Qué tipo de productos financieros tiene su hogar actualmente en Colombia?",
    x = "Nivel de hacinamiento",
    y = "Porcentaje"
  ) +
  theme_minimal()
```

```{r comparacion variables de medios de vida}
# Total de hogares por categoría de hacinamiento
totales_hogares <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(total_hogares = n(), .groups = "drop")
```

```{r comparacion variables de medios de vida}
# --- Medios de vida 5 ---
resumen_mv5 <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    across(starts_with("mediosvida5_mediosvida5"), ~sum(. == "1", na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  left_join(totales_hogares, by = "hacinamiento") %>%
  mutate(
    porcentaje_hogares = round((conteo / total_hogares) * 100, 1),
    producto = str_remove(producto, "mediosvida5_mediosvida5_")
  )

```

```{r comparacion variables de medios de vida}
# --- Gráfico Medios de Vida 5 (Ingresos) ---
ggplot(resumen_mv5, aes(x = producto, y = porcentaje_hogares, fill = hacinamiento)) +
  geom_col(position = "dodge") +
  labs(
    title = "¿Actualmente en su hogar cuáles son las principales fuentes de ingresos/dinero?",
    x = "Fuente de ingresos",
    y = "% de hogares"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r comparacion variables de medios de vida}
# --- Medios de vida 7 ---
resumen_mv7 <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    across(starts_with("mediosvida7_mediosvida7"), ~sum(. == "1", na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  left_join(totales_hogares, by = "hacinamiento") %>%
  mutate(
    porcentaje_hogares = round((conteo / total_hogares) * 100, 1),
    producto = str_remove(producto, "mediosvida7_mediosvida7_")
  )
```

```{r comparacion variables de medios de vida}
# --- Medios de vida 7 ---
# --- Gráfico Medios de Vida 7 (Productos Financieros) ---
ggplot(resumen_mv7, aes(x = producto, y = porcentaje_hogares, fill = hacinamiento)) +
  geom_col(position = "dodge") +
  labs(
    title = "¿Qué tipo de productos financieros tiene su hogar actualmente en Colombia?",
    x = "Producto financiero",
    y = "% de hogares"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r Problemas de vivienda}
preg_multi <- c("alojamiento3")

cols_multi <- names(data_filtrada)[str_detect(
  names(data_filtrada),
  paste0("^(", paste(preg_multi, collapse="|"), ")_")
)]
```

```{r Problemas de vivienda}
data_alojamiento3 <- data_filtrada %>%
  pivot_longer(
    cols = all_of(cols_multi),
    names_to = c("pregunta", "respuesta"),
    names_pattern = "([^_]+)_(.*)",
    values_to = "valor"
  ) %>%
  filter(valor == 1)%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))
```

```{r Problemas de vivienda}
resumen_aloj3 <- data_alojamiento3 %>%
  count(respuesta, name = "conteo") %>%
  arrange(desc(conteo))

resumen_aloj3

```

```{r Problemas de vivienda}
ggplot(resumen_aloj3, aes(x = reorder(respuesta, -conteo), y = conteo, fill = respuesta)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Problemas relacionados con la vivienda y el entorno",
    x = "Tipo de problema reportado",
    y = "Número de hogares"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```

```{r Problemas de vivienda}
# Pasar a formato largo (solo respuestas marcadas = 1)
data_aloj3 <- data_filtrada %>%
  pivot_longer(
    cols = all_of(cols_multi),
    names_to = c("pregunta", "respuesta"),
    names_pattern = "([^_]+)_(.*)",
    values_to = "valor"
  ) %>%
  filter(valor == 1)
```

```{r Problemas de vivienda}
resumen_aloj3_menciones <- data_aloj3 %>%
  count(respuesta, name = "conteo") %>%
  arrange(desc(conteo))%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))

```

```{r Problemas de vivienda}
resumen_aloj3_hogar <- data_aloj3 %>%
  group_by(respuesta) %>%
  summarise(n_hogares = n_distinct(id_hogar), .groups = "drop")%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))

```

```{r Problemas de vivienda}
plot_aloj3_menciones <- ggplot(resumen_aloj3_menciones,
                               aes(x = respuesta, y = conteo, fill = respuesta)) +
  geom_col() +
  labs(title = "Problemas de vivienda (menciones)",
       x = "Problema reportado", y = "Número de menciones") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

plot_aloj3_hogar <- ggplot(resumen_aloj3_hogar,
                           aes(x = respuesta, y = n_hogares, fill = respuesta)) +
  geom_col() +
  labs(title = "Problemas de vivienda (hogares únicos)",
       x = "Problema reportado", y = "Número de hogares") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

# Mostrar juntos
plot_aloj3_menciones + plot_aloj3_hogar

```


```{r Problemas de vivienda}
vars_entorno <- c(
  "alojamiento3_alojamiento3_no_conflic",
  "alojamiento3_alojamiento3_no_higiene",
  "alojamiento3_alojamiento3_no_lnfaestruc",
  "alojamiento3_alojamiento3_no_privacidad",
  "alojamiento3_alojamiento3_desastres",
  "alojamiento3_alojamiento3_ninguna",
  "alojamiento3_alojamiento3_otro",
  "alojamiento3_alojamiento3_nosabe",
  "alojamiento3_alojamiento3_noresponde"
  )
```

```{r Problemas de vivienda}
resumen_entorno <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(across(all_of(vars_entorno), ~ sum(. == "1", na.rm = TRUE))) 

resumen_entorno
```


```{r Problemas de vivienda}

resumen_aloj3_hacinamiento <- resumen_entorno %>%
  select(hacinamiento, starts_with("alojamiento3")) %>% 
  pivot_longer(
    cols = -hacinamiento,
    names_to = "problema",
    values_to = "conteo"
  ) %>%
  group_by(hacinamiento) %>%
  mutate(
    total = sum(conteo, na.rm = TRUE),
    porcentaje = round((conteo / total) * 100, 1),
    problema = gsub("alojamiento3_alojamiento3_", "", problema)  # limpiar nombres
  ) %>%
  left_join(totales_hogares, by = "hacinamiento") %>%
  mutate(
    porcentaje_hogares = round((conteo / total_hogares) * 100, 1),
    producto = str_remove(problema, "alojamiento3_alojamiento3_")
  )


# --- Gráfico Problemas de vivienda ---
ggplot(resumen_aloj3_hacinamiento, aes(x = problema, y = porcentaje_hogares, fill = hacinamiento)) +
  geom_col(position = "dodge") +
  labs(
    title = "Problemas relacionados con la vivienda y el entorno",
    x = "Problema reportado",
    y = "% de hogares"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r Gasto en vivienda}
# Resumen de la variable de gasto en vivienda
summary(data_filtrada$san53_viv)

# Revisar cuántos NA hay
sum(is.na(data_filtrada$san53_viv))
```

```{r Gasto en vivienda}
# --- Resumen estadístico del gasto en vivienda
resumen_gasto_viv <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    n = n(),
    media = mean(san53_viv, na.rm = TRUE),
    mediana = median(san53_viv, na.rm = TRUE),
    p25 = quantile(san53_viv, 0.25, na.rm = TRUE),
    p75 = quantile(san53_viv, 0.75, na.rm = TRUE),
    maximo = max(san53_viv, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r Gasto en vivienda}
# --- Resumen estadístico del gasto en vivienda
print(resumen_gasto_viv) 
```

```{r Gasto en vivienda}
# --- Crear variable de gasto total
data_filtrada <- data_filtrada %>%
  mutate(
    gasto_total = rowSums(across(c(san52_alim, san53_viv, san54_serv,
                                   san55_sal, san56_edu, san57_otros)), na.rm = TRUE),
    pct_vivienda = if_else(gasto_total > 0, (san53_viv / gasto_total) * 100, NA_real_)
  )

# --- Revisar tabla de resumen
resumen_pct_viv <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    n = n(),
    media = mean(pct_vivienda, na.rm = TRUE),
    mediana = median(pct_vivienda, na.rm = TRUE),
    p25 = quantile(pct_vivienda, 0.25, na.rm = TRUE),
    p75 = quantile(pct_vivienda, 0.75, na.rm = TRUE),
    maximo = max(pct_vivienda, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r Gasto en vivienda}
print(resumen_pct_viv)
```

```{r Gasto en vivienda}
ggplot(data_filtrada, aes(x = hacinamiento, y = pct_vivienda, fill = hacinamiento)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.1, outlier.shape = NA) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Porcentaje del gasto total destinado a vivienda",
    x = "Nivel de hacinamiento",
    y = "% del gasto en vivienda"
  ) +
  scale_y_continuous(labels = percent_format(scale = 1)) +  # convierte a %
  theme(legend.position = "none")
```
