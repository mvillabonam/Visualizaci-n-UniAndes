---
title: "Taller 2 - Visualización y Exploración de bases de datos"
author: " Henry Carvajal (201718787),Julian Delgado (201712798) , Mariana Villabona (201816559)"
date: "Visualización y Exploración de datos para ciencias sociales"
output: html_document
---

```{r Setup, include=FALSE}
# --- Limpiar entorno
rm(list = ls())
gc()
closeAllConnections()

# --- Cargar librerías necesarias
library("pacman")
require("pacman")
p_load( tidyverse, data.table, lubridate, readxl, ggthemes, plotly, janitor,ggplot2,openxlsx, writexl,stringi, patchwork, skimr,tidyverse, readxl, ggthemes, plotly,)

# --- Definir rutas
user <- Sys.getenv("USERNAME")

if (user == "judel") {
  path <- file.path("C:/Users", "judel", "OneDrive", "Documentos", 
                    "ANDES", "Semestre 3", "Visualizacion de datos", "Actividad 2")
} else if (user == "mvill") {
  path <- file.path("C:/Users", "mvill", "OneDrive", "Transitorio", "OneDrive", 
                    "Documentos", "GitHub", "Visualizaci-n-UniAndes","Taller 2")
} else if (user == "hncar") {
  path <- file.path("C:/Users", "hncar", "Documents", "GitHub", "Visualizaci-n-UniAndes")
} else {
  path <- choose.dir(caption = "Selecciona la carpeta con los archivos")
}

setwd(path)


# --- Cargar datos 
data <- file.path(path, "data/2025 JNA VP.xlsx")

data_migracion_hogares  <- read_excel(data, sheet = "Hogares") %>% clean_names()
data_migracion_personas <- read_excel(data, sheet = "Personas") %>% clean_names()
```

# Limpieza y creación de variables latentes.
```{r Ajuste texto}
limpiar_texto <- function(df) {
  df[] <- lapply(df, function(x) {
    if (is.character(x) | is.factor(x)) {
      x <- tolower(as.character(x))                        # pasar a minúsculas
      x <- stri_trans_general(x, "Latin-ASCII")            # quitar tildes
      return(x)
    } else {
      return(x)  # dejar igual las variables que no son texto
    }
  })
  return(as.data.frame(df))
}

# --- Aplicar a tus bases
data_migracion_hogares  <- limpiar_texto(data_migracion_hogares)
data_migracion_personas <- limpiar_texto(data_migracion_personas)
```

```{r Union bases}
data_migracion <- data_migracion_hogares %>%
  left_join(data_migracion_personas, by = "id_hogar")
```


A.) Limpieza y creación de variables latentes para criterio de eligibilidad

```{r A. ELIGIBILIDAD }
##############################################
# EDAD Y SEXO 
##############################################

# Histograma Sexo
data_migracion$sexo_desagregado <- ifelse(data_migracion$demo2 == "Otro",
                                    "Otros",
                                    "Sexo biológico")

ggplot(data_migracion, aes(x = demo1)) +
  geom_histogram(bins = 20, fill = "steelblue", alpha = 0.7) +
  facet_wrap(~ sexo_desagregado + demo2, scales = "free_y") +
  labs(title = "Histograma de edad desagregado",
       x = "Edad", y = "Cuenta") +
  theme_minimal()

# Densidad por sexo y edad
ggplot(data_migracion, aes(x = demo1, fill = demo2)) +
  geom_density(alpha = 0.5) +
  labs(title = "Densidad de Edad por Sexo",
       x = "Edad",
       y = "Densidad") +
  theme_minimal()

# Probabilidades por edades
breaks <- pretty(range(data_migracion$demo1, na.rm = TRUE), n = 20)
dens_bins <- data_migracion %>%
  mutate(bin = cut(demo1, breaks = breaks, include.lowest = TRUE)) %>%
  group_by(demo2, bin) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(demo2) %>%
  mutate(freq = n / sum(n))  

# Rangos de edades 
data_migracion$rangos_edades <- cut(
  data_migracion$demo1,
  breaks = c(15, 25, 40, 70, Inf),
  labels = c("Joven", "Adulto Joven", "Adulto", "Adulto Mayor"),
  right = TRUE, include.lowest = TRUE
)


##############################################
# JEFES DE HOGAR 
##############################################
data_migracion %>%
  count(demo3) # Hay 8603 personas que reportan ser jefes de hogar

data_migracion %>%
  filter(!is.na(demo3) & demo3 != "") %>%
  count(demo5) # Todas las personas que no son jefes de hogar dicen poder
               # Responder por los miembros del hogar, coincide con                     # hogares sin jefes de hogar

# Identificar hogares sin jefes de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(no_tiene_jefe = as.integer(all(demo3 != "si" | is.na(demo3)))) %>%
  ungroup()

data_migracion %>%
  distinct(id_hogar, intro5, no_tiene_jefe) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = sum(no_tiene_jefe),
    hogares_total = n(),
    porcentaje_sin_jefe = round(100 * hogares_sin_jefe / hogares_total, 1)
  ) %>%
  arrange(desc(hogares_sin_jefe)) # Resumen por ciudad

# Contar quién se puede reasignar cómo jefe de hogar. 
resumen_por_ciudad <- data_migracion %>%
  filter(no_tiene_jefe == 1) %>%                      
  group_by(intro5, id_hogar) %>%
  summarise(
    Puede_responder_por_el_hogar = any(demo5 == "si", na.rm = TRUE),    
    Total_sí = sum(demo5 == "si", na.rm = TRUE),    
    Total_miembros_promedio_por_hogar = n(),                                  # número de personas en ese hogar
    .groups = "drop"
  ) %>%
  group_by(intro5) %>%
  summarise(
    hogares_sin_jefe = n(),   
    hogares_con_al_menos_un_sí = sum(Puede_responder_por_el_hogar),  
    promedio_sí_por_hogar = round(mean(Total_sí), 2),
    miembros_promedio = round(mean(Total_miembros_promedio_por_hogar), 2),    # promedio de miembros por hogar
    .groups = "drop"
  ) %>%
  arrange(desc(hogares_sin_jefe)) # En todos los hogares sin jefe de hogar
                                  # los miembros reportan que pueden responder                                   # por el resto. Por lo que se asigna                                          # aleatoriamente a cualquier integrante 
                                  # cómo jefe de hogar. 
resumen_por_ciudad

# Asignar un jefe de hogar
data_migracion <- data_migracion %>%
  group_by(id_hogar) %>%
  mutate(
    demo3 = ifelse(no_tiene_jefe == 1 & row_number() == 1, "si", demo3)
  ) %>%
  ungroup()

##############################################
# INTENCIÓN DE MOVERSE
##############################################
intencion_moverse <- data_migracion %>%
  pivot_longer(
    cols = c(demo21_ing_red,
             demo21_suf_disc,
             demo21_aum_prec,
             demo21_desal_viv,
             demo21_no_alim,
             demo21_no_acces_sal,
             demo21_of_lab,
             demo21_acc_edu,
             demo21_acc_edu_nna,
             demo21_otro_inten),
    names_to = "variable",
    values_to = "valor"
  ) %>%
  group_by(intro5, variable) %>%
  summarise(n_1 = sum(valor == 1, na.rm = TRUE), .groups = "drop") %>%
  arrange(intro5, variable)
intencion_moverse

# Moverse por Ingresos 

# Moverse por carencias de servicios (incluye educación y alimentación)


# Moverse por discriminación (incluye desalojo)

# Moverse por otras causas


rm(dens_bins)
```


```{r Filyto ciudad y creacion variable hacinamiento}
# --- Filtrar Bogotá
data_bogota <- data_migracion %>%
  filter(intro5 == "bogota. d.c.")

# --- Quedarse con un registro por hogar, prefiriendo demo3 == "si"
data_filtrada <- data_bogota %>%
  group_by(id_hogar) %>%
  arrange(desc(demo3 == "si")) %>%  # ordena poniendo primero los que tienen demo3 == "si"
  slice(1) %>%                      # toma el primer registro de cada hogar
  ungroup()

# --- Calcular índice de hacinamiento
data_filtrada <- data_filtrada %>%
  mutate(
    personas_cuarto = miembros1 / alojamiento7,
    hacinamiento = case_when(
      is.na(personas_cuarto) ~ NA_character_,
      personas_cuarto <= 2 ~ "Sin hacinamiento",
      personas_cuarto > 2 & personas_cuarto <= 3 ~ "Moderado",
      personas_cuarto > 3 ~ "Crítico"
    )
  )

```

Se prioriza el registro del jefe de hogar en caso de no existir se escoje otro

```{r Filtro Jefe de hogar}
# Variables únicas (riesgo desalojo, intención moverse, tiempo residencia)
vars_unica <- c("miembros1", "alojamiento7", "demo22", "demo12a")
```

```{r NA}
# --- NA en variables únicas
na_resumen <- sapply(data_filtrada[vars_unica], function(x) sum(is.na(x)))
na_resumen
```
```{r distribucion hacinamiento}
table(data_filtrada$hacinamiento, useNA = "ifany")
```
```{r distribucion hacinamiento}
# Orden lógico de categorías
data_filtrada$hacinamiento <- factor(
  data_filtrada$hacinamiento,
  levels = c("Sin hacinamiento", "Moderado", "Crítico")
)

# Gráfico de barras
ggplot(data_filtrada, aes(x = hacinamiento, fill = hacinamiento)) +
  geom_bar() +
  theme_minimal() +
  labs(
    title = "Distribución del hacinamiento en Bogotá",
    x = "Categoría de hacinamiento",
    y = "Número de hogares"
  ) +
  theme(legend.position = "none")
```
```{r distribucion hacinamiento}
hacinamiento_resumen <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(Frecuencia = n()) %>%
  mutate(Proporcion = round(100 * Frecuencia / sum(Frecuencia), 1))

hacinamiento_resumen
```

```{r comparacion variables de interes}
table(data_filtrada$hacinamiento, data_filtrada$demo22, useNA = "ifany")
```

```{r comparacion variables de medios de vida}
vars_financieras <- c(
  # Fuentes de ingreso
  "mediosvida5_mediosvida5_prestamos",
  "mediosvida5_mediosvida5_ahorros",
  "mediosvida5_mediosvida5_trabajo",
  "mediosvida5_mediosvida5_asistencia",
  "mediosvida5_mediosvida5_apoyocomunidad",
  "mediosvida5_mediosvida5_venderbienes",
  "mediosvida5_mediosvida5_donaciones",
  "mediosvida5_mediosvida5_notiene",  
  "mediosvida5_mediosvida5_otra",   
  "mediosvida5_mediosvida5_nosabe",  
  "mediosvida5_mediosvida5_prefiereno",    
  
  # Productos financieros
  "mediosvida7_mediosvida7_cuenta_ahorro",
  "mediosvida7_mediosvida7_cuenta_corriente",
  "mediosvida7_mediosvida7_cdt",
  "mediosvida7_mediosvida7_billetera_electronica",
  "mediosvida7_mediosvida7_deposito_bajo_monto",
  "mediosvida7_mediosvida7_microcredito",
  "mediosvida7_mediosvida7_prestamo_vivienda",
  "mediosvida7_mediosvida7_prestamo_vehiculo",
  "mediosvida7_mediosvida7_prestamo_de_libre_inversion",
  "mediosvida7_mediosvida7_tarjeta_de_credito",
  "mediosvida7_mediosvida7_otro",  
  "mediosvida7_mediosvida7_ninguno", 
  "mediosvida7_mediosvida7_no_sabe", 
  "mediosvida7_mediosvida7_noresponde"

)
```

```{r comparacion variables de interes}
resumen_financieros <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(across(all_of(vars_financieras), ~ sum(. == "1", na.rm = TRUE))) 

resumen_financieros
```

```{r comparacion variables de interes}
resumen_finanzas_largo <- resumen_financieros %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  )



resumen_finanzas_largo <- resumen_finanzas_largo %>%
  mutate(producto = str_replace_all(producto,
                                    c("mediosvida5_" = "",
                                      "mediosvida7_" = "")))

head(resumen_finanzas_largo, 10)
```

```{r comparacion variables de interes}
# --- Para MEDIOS DE VIDA 5 (fuentes de ingresos/dinero)
resumen_mv5 <- resumen_financieros %>%
  select(hacinamiento, starts_with("mediosvida5")) %>% 
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  group_by(hacinamiento) %>%
  mutate(
    total = sum(conteo, na.rm = TRUE),
    porcentaje = round((conteo / total) * 100, 1),
    producto = gsub("mediosvida5_mediosvida5_", "", producto)  # limpiar nombres
  )

# --- Para MEDIOS DE VIDA 7 (productos financieros)
resumen_mv7 <- resumen_financieros %>%
  select(hacinamiento, starts_with("mediosvida7")) %>% 
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  group_by(hacinamiento) %>%
  mutate(
    total = sum(conteo, na.rm = TRUE),
    porcentaje = round((conteo / total) * 100, 1),
    producto = gsub("mediosvida7_mediosvida7_", "", producto)  # limpiar nombres
  )
```

```{r comparacion variables de interes}
# --- Gráfico 1: Fuentes de ingresos (MV5)
ggplot(resumen_mv5, aes(x = hacinamiento, y = porcentaje, fill = producto)) +
  geom_col(position = "stack") +
  labs(
    title = "¿Actualmente en su hogar cuáles son las principales fuentes de ingresos/dinero?",
    x = "Nivel de hacinamiento",
    y = "Porcentaje"
  ) +
  theme_minimal()
```
```{r comparacion variables de interes}
# --- Gráfico 2: Productos financieros (MV7)
ggplot(resumen_mv7, aes(x = hacinamiento, y = porcentaje, fill = producto)) +
  geom_col(position = "stack") +
  labs(
    title = "¿Qué tipo de productos financieros tiene su hogar actualmente en Colombia?",
    x = "Nivel de hacinamiento",
    y = "Porcentaje"
  ) +
  theme_minimal()
```

```{r comparacion variables de interes}
# Total de hogares por categoría de hacinamiento
totales_hogares <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(total_hogares = n(), .groups = "drop")
```

```{r comparacion variables de interes}
# --- Medios de vida 5 ---
resumen_mv5 <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    across(starts_with("mediosvida5_mediosvida5"), ~sum(. == "1", na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  left_join(totales_hogares, by = "hacinamiento") %>%
  mutate(
    porcentaje_hogares = round((conteo / total_hogares) * 100, 1),
    producto = str_remove(producto, "mediosvida5_mediosvida5_")
  )

```

```{r comparacion variables de interes}
# --- Gráfico Medios de Vida 5 (Ingresos) ---
ggplot(resumen_mv5, aes(x = producto, y = porcentaje_hogares, fill = hacinamiento)) +
  geom_col(position = "dodge") +
  labs(
    title = "¿Actualmente en su hogar cuáles son las principales fuentes de ingresos/dinero?",
    x = "Fuente de ingresos",
    y = "% de hogares"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r comparacion variables de interes}
# --- Medios de vida 7 ---
resumen_mv7 <- data_filtrada %>%
  group_by(hacinamiento) %>%
  summarise(
    across(starts_with("mediosvida7_mediosvida7"), ~sum(. == "1", na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = -hacinamiento,
    names_to = "producto",
    values_to = "conteo"
  ) %>%
  left_join(totales_hogares, by = "hacinamiento") %>%
  mutate(
    porcentaje_hogares = round((conteo / total_hogares) * 100, 1),
    producto = str_remove(producto, "mediosvida7_mediosvida7_")
  )
```

```{r comparacion variables de interes}
# --- Medios de vida 7 ---
# --- Gráfico Medios de Vida 7 (Productos Financieros) ---
ggplot(resumen_mv7, aes(x = producto, y = porcentaje_hogares, fill = hacinamiento)) +
  geom_col(position = "dodge") +
  labs(
    title = "¿Qué tipo de productos financieros tiene su hogar actualmente en Colombia?",
    x = "Producto financiero",
    y = "% de hogares"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r comparacion variables de interes}
preg_multi <- c("alojamiento3")

cols_multi <- names(data_filtrada)[str_detect(
  names(data_filtrada),
  paste0("^(", paste(preg_multi, collapse="|"), ")_")
)]
```

```{r comparacion variables de interes}
data_alojamiento3 <- data_filtrada %>%
  pivot_longer(
    cols = all_of(cols_multi),
    names_to = c("pregunta", "respuesta"),
    names_pattern = "([^_]+)_(.*)",
    values_to = "valor"
  ) %>%
  filter(valor == 1)%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))
```

```{r comparacion variables de interes}
resumen_aloj3 <- data_alojamiento3 %>%
  count(respuesta, name = "conteo") %>%
  arrange(desc(conteo))

resumen_aloj3

```

```{r comparacion variables de interes}
ggplot(resumen_aloj3, aes(x = reorder(respuesta, -conteo), y = conteo, fill = respuesta)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Problemas relacionados con la vivienda y el entorno",
    x = "Tipo de problema reportado",
    y = "Número de hogares"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```
```{r comparacion variables de interes}
# Pasar a formato largo (solo respuestas marcadas = 1)
data_aloj3 <- data_filtrada %>%
  pivot_longer(
    cols = all_of(cols_multi),
    names_to = c("pregunta", "respuesta"),
    names_pattern = "([^_]+)_(.*)",
    values_to = "valor"
  ) %>%
  filter(valor == 1)
```

```{r comparacion variables de interes}
resumen_aloj3_menciones <- data_aloj3 %>%
  count(respuesta, name = "conteo") %>%
  arrange(desc(conteo))%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))

```

```{r comparacion variables de interes}
resumen_aloj3_hogar <- data_aloj3 %>%
  group_by(respuesta) %>%
  summarise(n_hogares = n_distinct(id_hogar), .groups = "drop")%>%
  mutate(respuesta = str_remove(respuesta, "^alojamiento3_"))

```

```{r comparacion variables de interes}
plot_aloj3_menciones <- ggplot(resumen_aloj3_menciones,
                               aes(x = respuesta, y = conteo, fill = respuesta)) +
  geom_col() +
  labs(title = "Problemas de vivienda (menciones)",
       x = "Problema reportado", y = "Número de menciones") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

plot_aloj3_hogar <- ggplot(resumen_aloj3_hogar,
                           aes(x = respuesta, y = n_hogares, fill = respuesta)) +
  geom_col() +
  labs(title = "Problemas de vivienda (hogares únicos)",
       x = "Problema reportado", y = "Número de hogares") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

# Mostrar juntos
plot_aloj3_menciones + plot_aloj3_hogar

```
