---
title: "Proyecto 2 - Visualización y Exploración de bases de datos"
author: " Henry Carvajal (201718787),Julian Delgado (201712798) , Mariana Villabona (201816559)"
date: "Visualización y Exploración de datos para ciencias sociales"
output: html_document
---
```{r Setup}

# --- Limpiar entorno
rm(list = ls())
gc()
closeAllConnections()

# --- Cargar librerías necesarias
library("pacman")
require("pacman")
p_load( tidyverse, data.table, lubridate, readxl, ggthemes, plotly, janitor,ggplot2,openxlsx, writexl,stringi, patchwork, skimr,tidyverse, readxl, ggthemes, plotly,sf,osmdata,dplyr, scales)

# --- Definir rutas
user <- Sys.getenv("USERNAME")

# Obtener usuario del sistema y directorio de trabajo
directorio <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(directorio)

# Buscar bases de datos
ruta_datos <- file.path(directorio, "data/GEIH_2024")
options(scipen = 999)  # desactiva notación científica

```


```{r Union bases, warning=FALSE}
meses <- 1:12
llave <- c("PERIODO", "MES", "PER", "DPTO", "DIRECTORIO", "SECUENCIA_P", "ORDEN", "FEX_C18")

lista_meses <- list()

for (m in meses) {

  archivos <- c(
    "Características generales, seguridad social en salud y educación.csv",
    "Fuerza de trabajo.csv",
    "No ocupados.csv",
    "Ocupados.csv"
  )
  nombres <- c("generales", "fuerza", "desocupados", "ocupados")

  for (i in seq_along(archivos)) {
    ruta <- file.path(ruta_datos, m, archivos[i])
    #datos <- read.csv(ruta, sep = ";", dec = ".", fileEncoding = "UTF-8", stringsAsFactors = FALSE)
    datos <- read_delim(
      file   = ruta,
      delim  = ";",
      locale = locale(encoding = "Latin1"),
      trim_ws = TRUE,
      show_col_types = FALSE
    )
    assign(nombres[i], datos)
  }

  base_mes <- generales %>%
    left_join(fuerza, by = llave) %>%
    left_join(ocupados, by = llave) %>%
    left_join(desocupados, by = llave)

  lista_meses[[m]] <- base_mes
}

# Limpieza de formatos
lista_meses <- lapply(lista_meses, function(df) {
  df %>% mutate(OFICIO_C8 = as.character(OFICIO_C8),
                MES = as.character(MES))
})

ANUAL <- bind_rows(lista_meses)

rm(base_mes, generales, fuerza, ocupados, desocupados, datos)
```


```{r Seleccionar variables relevantes}
variables_select <- ANUAL %>%
  select(
    # Identificación
    PERIODO, MES, DIRECTORIO, SECUENCIA_P, ORDEN,
    # Sexo, edad
    P3271, P6040,
    # Educación
    P3042,
    # Mercado laboral
    P6240, P6240S1, P6240S2,
    P6430, OCI,OFICIO1_C8,
    # Ubicación
    DPTO, AREA.x, CLASE.x,
   # Factor de expansión
    FEX_C18
  )

#Check de que está quedando bien
factores_mes <- ANUAL %>%
  group_by(MES) %>%
  summarise(suma_fex = sum(as.numeric(FEX_C18)/12, na.rm = TRUE)) %>%
  arrange(MES)

```


```{r Seleccionar variables relevantes}
variables_select <- variables_select %>%
  mutate(
    PERIODO = as.Date(as.character(PERIODO), format = "%Y%m%d"),
    ANO = format(PERIODO, "%Y")
  ) %>%
  select(-PERIODO)

sapply(variables_select, function(x) sum(is.na(x)))
```


```{r Ajustar Variables}
variables_etiquetas <- variables_select %>%
  mutate(
    P3271 = case_when(
      P3271 == 1 ~ "Hombre",
      P3271 == 2 ~ "Mujer"))
    
variables_etiquetas <- variables_etiquetas %>%
  mutate(
    P3042 = case_when(
      P3042 == 1  ~ "Ninguno",
      P3042 == 2  ~ "Preescolar",
      P3042 == 3  ~ "Básica primaria (1-5)",
      P3042 == 4  ~ "Básica secundaria (6-9)",
      P3042 == 5  ~ "Media académica",
      P3042 == 6  ~ "Media técnica",
      P3042 == 7  ~ "Normalista",
      P3042 == 8  ~ "Técnica profesional",
      P3042 == 9  ~ "Tecnológica",
      P3042 == 10 ~ "Universitaria",
      P3042 == 11 ~ "Especialización",
      P3042 == 12 ~ "Maestría",
      P3042 == 13 ~ "Doctorado",
      P3042 == 99 ~ "No sabe / No informa",
      is.na(P3042) ~ "Otro / No especificado"
    ))

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    P6240 = case_when(
      P6240 == 1 ~ "Trabajando",
      P6240 == 2 ~ "Buscando trabajo",
      P6240 == 3 ~ "Estudiando",
      P6240 == 4 ~ "Oficios del hogar",
      P6240 == 5 ~ "Incapacitado permanente",
      P6240 == 6 ~ "Otra actividad",
      is.na(P6240) ~ "Otro / No especificado"
    ))

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    P6430 = case_when(
      P6430 == 1 ~ "Obrero o empleado empresa privada",
      P6430 == 2 ~ "Obrero o empleado gobierno",
      P6430 == 3 ~ "Empleado doméstico",
      P6430 == 4 ~ "Cuenta propia",
      P6430 == 5 ~ "Patrón o empleador",
      P6430 == 6 ~ "Familiar sin remuneración",
      P6430 == 7 ~ "No remunerado en negocio de otros hogares",
      P6430 == 8 ~ "Jornalero o peón",
      P6430 == 9 ~ "Otro",
      is.na(P6430) ~ "Otro / No especificado"
    ))

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    fex_c = as.numeric(FEX_C18),
    edad = as.numeric(P6040),
  )

variables_etiquetas <- variables_etiquetas %>%
  filter(edad >= 18)

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    estado_laboral = case_when(
      P6240 == "Trabajando" ~ "Ocupado",
      P6240 == "Buscando trabajo" ~ "Desocupado",
      P6240 %in% c("Estudiando", "Oficios del hogar",
                   "Incapacitado permanente", "Otra actividad") ~ "Inactivo",
      P6240 == 14 ~ "No especificado",
      is.na(P6240) ~ "No clasificado"
    )
  )

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    participa = case_when(
      estado_laboral %in% c("Ocupado", "Desocupado") ~ 1,
      estado_laboral == "Inactivo" ~ 0,
      is.na(estado_laboral) ~ NA_real_
    )
  )

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    region = case_when(
      # --- CARIBE ---
      DPTO %in% c("08", "13", "20", "44", "47", "70", "23") ~ "Caribe",
      # --- ANDINA ---
      DPTO %in% c("05", "11", "15", "17", "41", "68", "73", "54",
                  "25", "63", "66") ~ "Andina",
      # --- PACÍFICO ---
      DPTO %in% c("19", "27", "52", "76") ~ "Pacífico",
      # --- ORINOQUÍA ---
      DPTO %in% c("81", "85", "50") ~ "Orinoquía",
      # --- AMAZONÍA ---
      DPTO %in% c("91", "94", "95", "97", "99", "86") ~ "Amazonía",
      # --- INSULAR ---
      DPTO %in% c("88") ~ "Insular",
      TRUE ~ NA_character_
    )
  )

variables_etiquetas <- variables_etiquetas %>%
  mutate(
    Departamento = case_when(
      DPTO == "05" ~ "Antioquia",
      DPTO == "08" ~ "Atlántico",
      DPTO == "13" ~ "Bolívar",
      DPTO == "15" ~ "Boyacá",
      DPTO == "17" ~ "Caldas",
      DPTO == "18" ~ "Caquetá",
      DPTO == "19" ~ "Cauca",
      DPTO == "20" ~ "Cesar",
      DPTO == "23" ~ "Córdoba",
      DPTO == "25" ~ "Cundinamarca",
      DPTO == "27" ~ "Chocó",
      DPTO == "41" ~ "Huila",
      DPTO == "44" ~ "La Guajira",
      DPTO == "47" ~ "Magdalena",
      DPTO == "50" ~ "Meta",
      DPTO == "52" ~ "Nariño",
      DPTO == "54" ~ "Norte de Santander",
      DPTO == "63" ~ "Quindío",
      DPTO == "66" ~ "Risaralda",
      DPTO == "68" ~ "Santander",
      DPTO == "70" ~ "Sucre",
      DPTO == "73" ~ "Tolima",
      DPTO == "76" ~ "Valle del Cauca",
      TRUE ~ NA_character_    # Diccionario de microdatos no incluye todos los numeros 
    )
  )


```

```{r Na}
vars_relevantes <- c("P3271","edad","P3042","P6240","P6430","DPTO","fex_c", "estado_laboral")

na_summary <- sapply(variables_etiquetas[vars_relevantes], function(x) {
  round(mean(is.na(x)) * 100, 2)
})

na_summary
```

```{r Outliers}
Q1 <- quantile(variables_etiquetas$edad, 0.25)
Q3 <- quantile(variables_etiquetas$edad, 0.75)
IQR <- Q3 - Q1
lim_inf <- Q1 - 1.5*IQR
lim_sup <- Q3 + 1.5*IQR

sum(variables_etiquetas$edad < lim_inf | variables_etiquetas$edad > lim_sup)

```
Para identificar posibles valores atípicos en la variable edad, se aplicó el criterio estadístico basado en el rango intercuartílico (IQR). Se calcularon los límites inferior y superior como Q1 − 1.5·IQR y Q3 + 1.5·IQR, respectivamente. A partir de este procedimiento se identificaron 9 observaciones con edades entre 103 y 108 años.

Tras revisar manualmente estos registros, se concluyó que, aunque poco frecuentes, estas edades son plausibles en una encuesta poblacional como la GEIH. Por lo tanto, no se consideraron errores ni valores imposibles, y se decidió conservarlos en la base de datos, evitando introducir un sesgo por eliminación injustificada de adultos mayores. Esta decisión no afecta de manera significativa los análisis posteriores, dado su bajo peso relativo en la muestra.

```{r Outliers}
outliers_edad <- variables_etiquetas %>%
  filter(edad < lim_inf | edad > lim_sup) %>%
  select(DIRECTORIO, SECUENCIA_P, ORDEN, edad)

outliers_edad


```

```{r }
summary(variables_etiquetas$edad)

table(variables_etiquetas$P3271)
prop.table(table(variables_etiquetas$P3271)) * 100

table(variables_etiquetas$estado_laboral)
prop.table(table(variables_etiquetas$estado_laboral)) * 100

table(variables_etiquetas$P3042)

table(variables_etiquetas$DPTO)
```


```{r Univariado}
# Frecuencia
table(variables_etiquetas$P3271)

# Porcentajes
prop.table(table(variables_etiquetas$P3271)) * 100

# Gráfico
ggplot(variables_etiquetas, aes(P3271, weight = fex_c, fill = P3271)) +
  geom_bar(width = 0.6, alpha = 0.9) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("#4E79A7", "#F28E2B")) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Distribución por género",
    y = "Personas (expandido)",
    x = "Género"
  ) +
  theme(legend.position = "none")

```


```{r Univariado}

summary(variables_etiquetas$edad)

ggplot(variables_etiquetas, aes(edad)) +
  geom_histogram(
    aes(y = ..density..),
    bins = 40,
    fill = "#4E79A7",
    color = "white",
    alpha = 0.75
  ) +
  geom_density(color = "red", size = 1, alpha = 0.7) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Distribución de la edad de la población (con densidad)",
    x = "Edad",
    y = "Densidad"
  )


ggplot(variables_etiquetas, aes(x = "", y = edad)) +
  geom_violin(fill = "#4E79A7", alpha = 0.7) +
  stat_summary(fun = median, geom = "point", size = 3, color = "red") +
  theme_minimal(base_size = 13) +
  labs(
    title = "Distribución de la edad con mediana",
    x = "",
    y = "Edad"
  )

```


```{r Univariado}
table(variables_etiquetas$P3042)
prop.table(table(variables_etiquetas$P3042)) * 100

ggplot(variables_etiquetas, aes(P3042, weight = fex_c)) +
  geom_bar() +
  coord_flip() +
  theme_minimal() +
  labs(title = "Nivel educativo de la población",
       x = "Nivel educativo",
       y = "Personas (expandido)")

```


```{r Univariado}
df_pct <- variables_etiquetas %>%
  count(P3042, wt = fex_c) %>%
  mutate(pct = n / sum(n) * 100)

ggplot(df_pct, aes(x = fct_reorder(P3042, pct), y = pct)) +
  geom_col(fill = "#4A6FA5") +
  coord_flip() +
  labs(
    title = "Nivel educativo de la población",
    x = "Nivel educativo",
    y = "Porcentaje (%)"
  ) +
  theme_minimal(base_size = 13)

```


```{r Univariado}
df_lab <- variables_etiquetas %>%
  count(P6240, wt = fex_c) %>%
  mutate(pct = n / sum(n) * 100)

ggplot(df_lab, aes(x = fct_reorder(P6240, pct), y = pct)) +
  geom_col(fill = "#4A6FA5") +
  coord_flip() +
  labs(
    title = "Condición laboral declarada",
    x = "Actividad",
    y = "Porcentaje (%)"
  ) +
  theme_minimal(base_size = 13)

```


```{r Univariado}
# Participación laboral (1 = participa, 0 = no participa)
table(variables_etiquetas$participa)
prop.table(table(variables_etiquetas$participa)) * 100

ggplot(variables_etiquetas, aes(as.factor(participa), weight = fex_c)) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Participación laboral de la población adulta",
       x = "Participa (1 = sí)",
       y = "Personas (expandido)")

```


```{r Univariado}
# Frecuencia por región
table(variables_etiquetas$region)
prop.table(table(variables_etiquetas$region)) * 100

# Gráfico
ggplot(variables_etiquetas, aes(region, weight = fex_c)) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Distribución de la población por región",
       x = "Región",
       y = "Personas (expandido)")

```


```{r bivariado}
# Participación por género
participacion_genero <- variables_etiquetas %>%
  group_by(P3271) %>%
  summarise(
    tasa_participacion = weighted.mean(participa, w = fex_c, na.rm = TRUE)
  )

participacion_genero

```


```{r bivariado}
ggplot(participacion_genero, aes(x = P3271, y = tasa_participacion, fill = P3271)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Tasa de participación laboral por género",
    x = "Género",
    y = "Tasa de participación"
  )

```


```{r bivariado}
participacion_region <- variables_etiquetas %>%
  group_by(region) %>%
  summarise(
    tasa_participacion = weighted.mean(participa, w = fex_c, na.rm = TRUE)
  )

participacion_region

```


```{r bivariado}
ggplot(participacion_region, aes(x = region, y = tasa_participacion, fill = region)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Tasa de participación laboral por región",
    x = "Región",
    y = "Tasa de participación"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r bivariado}
participacion_genero_region <- variables_etiquetas %>%
  group_by(region, P3271) %>%
  summarise(
    tasa = weighted.mean(participa, w = fex_c, na.rm = TRUE),
    n = n()
  )

participacion_genero_region

```


```{r bivariado}
ggplot(participacion_genero, aes(x = P3271, y = tasa_participacion, fill = P3271)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Tasa de participación laboral por género",
    x = "Género",
    y = "Tasa de participación"
  )


```


```{r bivariado}
brecha_genero_region <- participacion_genero_region %>%
  select(region, P3271, tasa) %>%
  pivot_wider(names_from = P3271, values_from = tasa) %>%
  mutate(brecha = Hombre - Mujer)
brecha_genero_region

participacion_region_sexo <- variables_etiquetas %>%
  filter(P3271 %in% c("Hombre", "Mujer"),
         !is.na(region),
         !is.na(participa),
         !is.na(fex_c)) %>%
  group_by(region, P3271) %>%
  summarise(
    tasa_participacion = sum(participa * fex_c, na.rm = TRUE) /
                         sum(fex_c, na.rm = TRUE),
    .groups = "drop"
  )
participacion_region_sexo

# Gráfico conjunto por región
ggplot(participacion_region_sexo,
       aes(x = P3271, y = tasa_participacion, fill = P3271)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(label = scales::percent(tasa_participacion, accuracy = 0.1)),
    vjust = -0.5,
    size = 3
  ) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    limits = c(0, 1)
  ) +
  facet_wrap(~ region) +
  labs(
    title = "Tasa de participación laboral por sexo y región",
    subtitle = "Proporciones ponderadas con el factor de expansión",
    x = "",
    y = "Tasa de participación",
    fill = "Sexo"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom"
  )
```

```{r}
library(dplyr)
library(purrr)

# Aseguramos orden consistente Hombre / Mujer
datos_test <- variables_etiquetas %>%
  filter(P3271 %in% c("Hombre", "Mujer"),
         !is.na(region),
         !is.na(participa),
         !is.na(fex_c)) %>%
  group_by(region, P3271) %>%
  summarise(
    x = sum(participa * fex_c, na.rm = TRUE),  
    n = sum(fex_c, na.rm = TRUE),            
    .groups = "drop"
  ) %>%
  arrange(region, factor(P3271, levels = c("Hombre", "Mujer")))

# Correr prop.test por región
resultados_region <- datos_test %>%
  group_by(region) %>%
  summarise(
    prueba = list(prop.test(x = x, n = n)),
    .groups = "drop"
  ) %>%
  mutate(
    prop_h = map_dbl(prueba, ~ .x$estimate[1]),      # p_hombres
    prop_m = map_dbl(prueba, ~ .x$estimate[2]),      # p_mujeres
    dif_h_m = prop_h - prop_m,                       # brecha
    p_value = map_dbl(prueba, ~ .x$p.value),
    ic_inf = map_dbl(prueba, ~ .x$conf.int[1]),
    ic_sup = map_dbl(prueba, ~ .x$conf.int[2])
  ) %>%
  select(region, prop_h, prop_m, dif_h_m, ic_inf, ic_sup, p_value)

resultados_region
write_xlsx(resultados_region, "resultados_region.xlsx")


```

